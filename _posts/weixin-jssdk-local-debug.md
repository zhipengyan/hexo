title: 利用ssh反向隧道本地调试微信
date: 2015-05-26 00:52:22
categories: 前端
tags: [微信,jssdk]
---
这几天工作上一个任务是能够自定义微信的分享内容（定义标题、图片和描述），感觉挺简单的，但是这是一个坑的开始。网上搜到的前端js方法都在去年年底被官方屏蔽掉了，这样子浪费了大半天的功夫。那就只能用官方的js-sdk了，但接下来就是签名认证，坑爹啊，只有认证帐号才能使用，还有域名限制，无非是想收钱罢了。也就是说你使用手机通过本地局域网在微信中打开网页是无济于事的，签名是通不过的，jssdk也没有使用权限。没法子只能代码中加入各种alert放到线上测试环境，线上产品很庞大，部署麻烦，同时影响他人测试使用，大大影响开发效率，最重要的是无法进行任何的调试。
<!--more-->

从同事口中得知可以使用[localtunnel](https://github.com/progrium/localtunnel)将本地环境映射到外网，通过这个外网地址可以访问本地环境。确实很方便，一个命令就解决了，问题是这是外国人做的，服务器啥的肯定也都在国外，那速度简直不能忍，企业宽带打开都得几分钟，另外这种网络环境下基本没办法调试，容易断线和超时。

再后来无意中看到ssh反向隧道可以使用，只要有一个公网服务器就行，刚好我有一个linode的vps，速度也很可观，遂开始研究怎么用，其实非常简单。

>假设场景：
A服务器(domainA.com)--外网主机，例如你的vps
B电脑(localhost:3000)--你开发使用的电脑，开发时使用localhost:3000访问
C手机(移动设备)--可以连接外网，在微信中测试

#安装autossh
在B电脑中安装autossh，主要是为了保证ssh连接的稳定性，我在mac中直接用brew装了，linux中应该那些yum、apt-get都能直接装，windows下没研究，可能使用Cygwin会方便点。
```
brew install autossh
```

#连接ssh开启隧道
{% codeblock lang:bash %}
autossh -M 2132 user@ip_or_domain -N -R 9001:localhost:3000
{% endcodeblock %}

><b>ip_or_domain</b>
A服务器ip地址或者域名
<b>9001</b>
A服务器开放的端口，如果80端口没有占用可以直接使用80，如果想临时使用，可以解除80端口的占用，以使用80端口。如果想长久使用，又不影响服务器上其他网站，需要使用其他端口，我使用9001端口。
<b>localhost:3000</b>
B电脑上开发环境地址

命令执行后会提示输入用户密码，如果使用的是80端口，那这时候就可以通过domainA.com直接从外网打开你的开发环境了。如果你的domainA.com是已经ICP备案了，那么就可以在微信公众平台管理中添加js能够使用的域名后进行调试开发了。

#申请ICP备案的域名
我们都知道在天朝ICP备案的麻烦和时间的长度，所以我不可能为了调个微信去备案一个域名，最多也是借个备案域名（想太多了，谁会有啊），想到前段时间用过花生壳的域名，严格来说应该是二级域名，如果一级域名已经备案，二级当然也能通过，随便使用sfsjflfjs.wicp.net试了下，果真可以通过。但免费的不能修改A记录，只能配合tp-link使用，所以还是花了18块买了一个oicp.net的域名，然后修改A记录，指向vps，同时在vps中add了domain。在微信公众平台中添加oicp.net的域名，接着就可以在手机中打开，并顺利的通过了签名验证。

#其他端口的配置
如果是绑定的其他端口，在使用时候就需要在域名后面加端口访问，另外好像微信认证也过不了（没验证，我在微信后台填js使用域名时候加端口不给通过），所以我还是在公网上面使用了80端口访问。但目前公网vps的80端口已经给了博客在使用，不能为了这个把博客停了，因为博客本身也是nginx代理的，所以想能不能也给9001端口代理到80端口，只是域名不同。根据访问的不同的域名，代理到本地不同的端口，博客原有域名还是走的hexo的端口，然后新买的花生壳域名走的9001端口，9001端口刚好又是ssh跟本地计算机的通道，这样就算通了。下面是nginx的配置
{% codeblock lang:javascript %}
server{
    listen 80;
    server_name domain.oicp.net;
    location / {
       proxy_pass http://127.0.0.1:9001;
       proxy_http_version 1.1;
    }
}
{% endcodeblock %}
